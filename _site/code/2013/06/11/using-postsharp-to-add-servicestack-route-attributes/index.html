<!DOCTYPE html>
<html lang="en-us">
  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Using PostSharp to Add ServiceStack Route Attributes &middot; Joe Kampschmidt's Code
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,600,700' rel='stylesheet' type='text/css'>
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>

  <body>
    <div class="masthead">
      <div class="container center">

      <h2 class="masthead-title">
        <a href="/" title="also known as @jokecamp">Joe Kampschmidt's Code</a>
      </h2>

      <nav class="nav">
        <ul>



  
    
  

  

  
    
  

  
    
          <li><a class="" href="/posts/" title="Joe's Blog">Blog</a></li>
    
  

  
    
          <li><a class="" href="/projects/" title="Joe's Projects">Projects</a></li>
    
  

  


          <li><a href="https://github.com/jokecamp" title="Joe's github page - commit all the things"><i class="fa fa-github"></i></a></li>
          <li><a href="http://stackoverflow.com/users/215502/kampsj" title="Joe's stackoverflow account - aka street credit"><i class="fa fa-stack-overflow"></i></a></li>
          <li><a href="https://twitter.com/jokecamp" title="Joe's twitter account"><i class="fa fa-twitter"></i></a></li>
        </ul>
      </div>
      </nav>
    </div>
    <div class="container conte
      <div class="post">
  <h1 class="post-title">Using PostSharp to Add ServiceStack Route Attributes</h1>
  <span class="post-date">11 Jun 2013</span>
  <p><strong>Updated</strong>: Â The latest version of ServiceStack (v3.9.53) now includes the <a href="https://github.com/ServiceStack/ServiceStack/wiki/Routing#content-negotiation">.ext routing option</a> using the AllowRouteContentTypeExtensions configuration property. See The comments section for more information. I would use the framework instead of this custom approach. This example now really serves as a demonstration of using PostSharp to apply attributes in general.</p>

<hr>

<p><strong>An aspect oriented approach to adding data format to the route</strong></p>

<p>A common approach in restful APIs is to allow the consumer to provide the content type in the route as a file extension. For example: /api/movies.json or /api/movies.xml?genre=Action.</p>

<p>Currently, ServiceStack supports different formats via the querystring &quot;format&quot; parameter or via the headers. You can easily override the HTTP content type by simply specifying urls like the following: /api/movies?format=json. One way to make ServiceStack work with the file extensions is to explicitly put the formats into the RouteAttribute paths and adding your own RequestFilter to check for a provided format. See the RequestFilter code at the bottom of the post.</p>

<p>For Example:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="na">  [Routes(&quot;/shows.json&quot;)]</span>
<span class="na">  [Routes(&quot;/shows.xml&quot;)]</span>
<span class="na">  [Routes(&quot;/shows.csv&quot;)]</span>
  <span class="p">[</span><span class="n">Routes</span><span class="p">(</span><span class="s">&quot;/shows.jsv&quot;</span><span class="p">)</span>
  <span class="p">[</span><span class="n">Routes</span><span class="p">(</span><span class="s">&quot;/shows.jsv&quot;</span><span class="p">)</span>
  <span class="p">[</span><span class="n">Routes</span><span class="p">(</span><span class="s">&quot;/shows&quot;</span><span class="p">)</span>
</code></pre></div>
<p>However, this becomes cumbersome to manage. If you are using Aspect oriented programming and PostSharp there is an easier way. You can create an aspect to decorate your DTOs with the accepted content types.</p>

<p><strong>PostSharp Attribute to Turn one Route attribute into many route attributes.</strong></p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="c1">///</span>
<span class="c1">/// Turns one Route into many routes with different data formats</span>
<span class="c1">///</span>
<span class="c1">/// For example:</span>
<span class="c1">///</span>
<span class="c1">///     [RoutesWithDataFormats(&quot;/shows&quot;) =&gt; [Routes(&quot;/shows.json&quot;)]</span>
<span class="c1">///                                         [Routes(&quot;/shows.xml&quot;)]</span>
<span class="c1">///                                         [Routes(&quot;/shows.csv&quot;)]</span>
<span class="c1">///                                         [Routes(&quot;/shows.jsv&quot;)]</span>
<span class="c1">///                                         [Routes(&quot;/shows&quot;)]</span>
<span class="c1">///</span>
<span class="na">[MulticastAttributeUsage(MulticastTargets.Class, Inheritance = MulticastInheritance.Strict)]</span>
<span class="na">[Serializable]</span>
<span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">RoutesWithDataFormatsAttribute</span> <span class="p">:</span> <span class="n">TypeLevelAspect</span><span class="p">,</span> <span class="n">IAspectProvider</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="kt">string</span> <span class="n">_path</span><span class="p">;</span>
    <span class="k">private</span> <span class="kt">string</span> <span class="n">_verbs</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">RoutesWithDataFormatsAttribute</span><span class="p">(</span><span class="kt">string</span> <span class="n">path</span><span class="p">,</span> <span class="kt">string</span> <span class="n">verbs</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_path</span> <span class="p">=</span> <span class="n">path</span><span class="p">;</span>
        <span class="n">_verbs</span> <span class="p">=</span> <span class="n">verbs</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="nf">RoutesWithDataFormatsAttribute</span><span class="p">(</span><span class="kt">string</span> <span class="n">path</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_path</span> <span class="p">=</span> <span class="n">path</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// This method is called at build time and should just provide other aspects.</span>
    <span class="k">public</span> <span class="n">IEnumerable</span> <span class="nf">ProvideAspects</span><span class="p">(</span><span class="kt">object</span> <span class="n">targetElement</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">attributes</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">();</span>

        <span class="kt">var</span> <span class="n">formats</span> <span class="p">=</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span><span class="s">&quot;json&quot;</span><span class="p">,</span> <span class="s">&quot;xml&quot;</span><span class="p">,</span> <span class="s">&quot;csv&quot;</span><span class="p">,</span> <span class="s">&quot;jsv&quot;</span><span class="p">};</span>

        <span class="c1">// Add data format routes first!</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">format</span> <span class="k">in</span> <span class="n">formats</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">dataFormatPath</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;{0}.{1}&quot;</span><span class="p">,</span> <span class="n">_path</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
            <span class="n">attributes</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">CreateAspect</span><span class="p">(</span><span class="n">targetElement</span><span class="p">,</span> <span class="n">dataFormatPath</span><span class="p">,</span> <span class="n">_verbs</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="c1">// Then add plain route last</span>
        <span class="n">attributes</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">CreateAspect</span><span class="p">(</span><span class="n">targetElement</span><span class="p">,</span> <span class="n">_path</span><span class="p">,</span> <span class="n">_verbs</span><span class="p">));</span>

        <span class="k">return</span> <span class="n">attributes</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="n">AspectInstance</span> <span class="nf">CreateAspect</span><span class="p">(</span><span class="kt">object</span> <span class="n">targetElement</span><span class="p">,</span> <span class="kt">string</span> <span class="n">path</span><span class="p">,</span> <span class="kt">string</span> <span class="n">verbs</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">constructor</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrWhiteSpace</span><span class="p">(</span><span class="n">verbs</span><span class="p">)</span>
                        <span class="p">?</span> <span class="k">new</span> <span class="n">ObjectConstruction</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">RouteAttribute</span><span class="p">),</span> <span class="n">path</span><span class="p">)</span>
                        <span class="p">:</span> <span class="k">new</span> <span class="n">ObjectConstruction</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">RouteAttribute</span><span class="p">),</span> <span class="n">path</span><span class="p">,</span> <span class="n">verbs</span><span class="p">);</span>

        <span class="kt">var</span> <span class="n">introduceDataContractAspect</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CustomAttributeIntroductionAspect</span><span class="p">(</span><span class="n">constructor</span><span class="p">);</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nf">AspectInstance</span><span class="p">(</span><span class="n">targetElement</span><span class="p">,</span> <span class="n">introduceDataContractAspect</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>AppHost Request Filters to make it work</strong></p>

<p>You will of course need to filter for these formats and override the content types. You can do this by adding a RequestFilter in your AppHost.</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="c1">// Filters happen before every request! Even before auth check</span>
<span class="k">this</span><span class="p">.</span><span class="n">RequestFilters</span><span class="p">.</span><span class="n">Add</span><span class="p">((</span><span class="n">httpReq</span><span class="p">,</span> <span class="n">httpResp</span><span class="p">,</span> <span class="n">requestDto</span><span class="p">)</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="c1">// allow .xml and .json</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">httpReq</span><span class="p">.</span><span class="n">PathInfo</span><span class="p">.</span><span class="n">EndsWith</span><span class="p">(</span><span class="s">&quot;.xml&quot;</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">httpReq</span><span class="p">.</span><span class="n">ResponseContentType</span> <span class="p">=</span> <span class="n">ContentType</span><span class="p">.</span><span class="n">Xml</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">httpReq</span><span class="p">.</span><span class="n">PathInfo</span><span class="p">.</span><span class="n">EndsWith</span><span class="p">(</span><span class="s">&quot;.json&quot;</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">httpReq</span><span class="p">.</span><span class="n">ResponseContentType</span> <span class="p">=</span> <span class="n">ContentType</span><span class="p">.</span><span class="n">Json</span><span class="p">;</span>
            <span class="n">httpResp</span><span class="p">.</span><span class="n">ContentType</span> <span class="p">=</span> <span class="n">ContentType</span><span class="p">.</span><span class="n">Json</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">// and ect for the other data types. You can refactor this into cleaner code</span>
    <span class="p">});</span>
</code></pre></div>
</div>

<div class="tags">
Tags
 <div class='tag'>api</div>  <div class='tag'>restful</div>  <div class='tag'>servicestack</div> 
</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul>
    
      <li>
          <a href="/code/2014/06/28/alternate-way-to-build-your-own-football-db-sqlite-database/" title="Alternate way to build your own football.db sqlite database">Alternate way to build your own football.db sqlite database</a><span class="date">June 28</span>
      </li>
    
      <li>
          <a href="/fun/2014/06/07/building-a-raspberry-pi-photo-frame/" title="Building a Raspberry Pi Photo Frame">Building a Raspberry Pi Photo Frame</a><span class="date">June 7</span>
      </li>
    
      <li>
          <a href="/code/2014/06/06/resolving-angularjs-paths-in-asp-mvc-spa-iis/" title="Resolving AngularJS paths in a ASP.NET MVC SPA and IIS">Resolving AngularJS paths in a ASP.NET MVC SPA and IIS</a><span class="date">June 6</span>
      </li>
    
  </ul>
</div>

      <div class="footer">
        <p>
          <a href="https://github.com/jokecamp/jokecamp.com"><i class="fa fa-github"></i> View Source on GitHub</a> |
          <a href="/atom.xml" title="Atom Feed"></i>Atom</a> | <a href="/rss.xml" title="RSS Feed"><i class="fa fa-rss"></i> RSS</a></p>
        <p>Contact me at <a href="mailto:joe.kampschmidt@gmail.com" alt="email me">joe.kampschmdit@gmail.com</p>
      </div>
    </div>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-101247-6', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>

<!DOCTYPE html>
<html lang="en-us">
  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Code Generation using ServiceStack.OrmLite and T4 Text templates &middot; Joe Kampschmidt's Code
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,600,700' rel='stylesheet' type='text/css'>

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>

  <body>
    <div class="masthead">
      <div class="container center">

      <h2 class="masthead-title">
        <a href="/" title="also known as @jokecamp">Joe Kampschmidt's Code</a>
      </h2>

      <nav class="nav">
        
        
          
            
          
        
          
        
          
            
          
        
          
            
                  <a class="" href="/posts/" title="Blog Posts">Blog Posts</a>
            
          
        
          
            
                  <a class="" href="/projects/" title="Projects">Projects</a>
            
          
        
          
        
        <a href="https://github.com/jokecamp" title="Joe's github page - commit all the things">GitHub</a>
        <a href="http://stackoverflow.com/users/215502/kampsj" title="Joe's stackoverflow account - aka street credit">StackOverflow</a>
        <a href="https://twitter.com/jokecamp" title="Joe's twitter account">Twitter</a>
      </div>
      </nav>
    </div>
    <div class="container content">
      <div class="post">
  <h1 class="post-title">Code Generation using ServiceStack.OrmLite and T4 Text templates</h1>
  <span class="post-date">07 Sep 2013</span>
  <p>I was reading the <a href="https://github.com/ServiceStack/ServiceStack.OrmLite">ServiceStack.OrmLite</a> documentation on GitHub and stumbled upon an often overlooked T4 templates located in the /src/t4 folder.</p>

<p>From the page:</p>

<blockquote>
<p><a href="https://github.com/gkathire">Guru Kathiresan</a> continues to enhance OrmLite&#39;s T4 Template support which are useful when you want to automatically generate POCO&#39;s and strong-typed wrappers for executing stored procedures.</p>
</blockquote>

<p>Some of the key benefits:</p>

<ul>
<li><strong>generate stored procedure code for every user stored procedure in your database</strong></li>
<li><strong>generate all your DTOs (called POCOs in template) based on every user table in your database</strong>

<ul>
<li>Alias attribute for primary Keys created as Id allowing you to harness the benefits of the IHasId interface

<ul>
<li>AutoIncrement attribute for primary keys</li>
<li>Required attribute for non null database columns</li>
</ul></li>
</ul></li>
<li>very easy to customize the templates to your organization&#39;s standards/conventions</li>
</ul>

<h3><strong>When and why use the T4 templates?</strong></h3>

<p>If you are using code first development then you won’t need the templates. However, most developers don’t get to start from scratch on projects. The templates become crucial when working with a large pre-existing database and code base.</p>

<p>We are all tired of writing CRUD operations. There is no need to be typing out DTO definitions and writing stored procedure execution code manually. In most cases though you won&#39;t be able to just cleanly swap in the OrmLite code. You might have logic in existing stored procedures that refactoring would be very error prone. In these cases I’ve found that a combination of OrmLite CRUD operations and the more rudimentary System.Data.IDbCommand code is an ideal solution. This works very well because OrmLite works as simple extensions on the System.Data.* classes. In a recent project of mine I have a base OrmLite repo and have the ability to override any of the CRUD operations to use stored procedures that have been generated from the T4 templates as needed.</p>

<h3><strong>Improvements to the T4 templates</strong></h3>

<p>I’ve added some more features to the templates to a fork of the project. These new templates can be found at GitHub <a href="https://github.com/jokecamp/ServiceStack.OrmLite/tree/master/src/T4">jokecamp/ServiceStack.OrmLite/src/T4</a>. You will want to grab all three files (OrmLite.Core.ttinclude, OrmLite.Poco.tt, OrmLite.SP.tt) drop them into a class library and make sure you add your database connection string to the web.config. The main changes add support for <strong>databases with multiple schemas</strong> and some code changes to <strong>provide support for output parameters</strong>.</p>

<p>My changes include:</p>

<ul>
<li>Replace enum SPParamDir with System.Data.ParameterDirection</li>
<li>Added Schema to table definition queries</li>
<li>Added ordering to SQL meta data queries by Schema then by object name for DTOs and Stored Procedures</li>
<li>Added [Schema(&quot;&quot;)] attribute to generated DTOs to support multiple schemas</li>
<li>Changed stored procedure method names to use “schema_storedProcedureName”</li>
<li>Created wrapper class called OrmLiteStoredProcedureWrapper</li>
</ul>

<p>I created the <a href="https://github.com/jokecamp/ServiceStack.OrmLite/blob/master/src/T4/OrmLite.SP.tt#L33">OrmLiteStoredProcedureWrapper</a> class for accessing output parameters. After the execution of the stored procedure you will need access to the DbCommand parameters to get any output parameters. Currently the OrmLiteSPStatement class does not expose the private DbCommand property. For now I just created a wrapper class to return the statement and command so that developers can just drop in the changes without changing the core OrmLite library. However, another solution would be to expose the DbCommand property as public in the base OrmLite project.</p>

<p>Here is an example of the stored procedure generated code:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">static</span> <span class="n">OrmLiteStoredProcedureWrapper</span> <span class="nf">dbo_USP_SavePerson</span><span class="p">(</span>
    <span class="k">this</span> <span class="n">IDbConnection</span> <span class="n">dbConnection</span><span class="p">,</span>
    <span class="kt">int?</span> <span class="n">personID</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">?</span> <span class="n">returnTime</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span> <span class="kt">int?</span> <span class="n">returnID</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">dbCommand</span> <span class="p">=</span> <span class="p">(</span><span class="n">DbCommand</span><span class="p">)</span><span class="n">dbConnection</span><span class="p">.</span><span class="n">CreateCommand</span><span class="p">();</span>
    <span class="n">dbCommand</span><span class="p">.</span><span class="n">CommandText</span> <span class="p">=</span> <span class="s">&quot;dbo.USP_SavePerson&quot;</span><span class="p">;</span>
    <span class="n">dbCommand</span><span class="p">.</span><span class="n">CommandType</span> <span class="p">=</span> <span class="n">CommandType</span><span class="p">.</span><span class="n">StoredProcedure</span><span class="p">;</span>
    <span class="n">dbCommand</span><span class="p">.</span><span class="n">Transaction</span> <span class="p">=</span> <span class="n">OrmLiteConfig</span><span class="p">.</span><span class="n">TSTransaction</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">?</span>
      <span class="p">(</span><span class="n">DbTransaction</span><span class="p">)</span><span class="n">OrmLiteConfig</span><span class="p">.</span><span class="n">TSTransaction</span> <span class="p">:</span> <span class="k">null</span><span class="p">;</span>

    <span class="n">dbCommand</span><span class="p">.</span><span class="n">Parameters</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">CreateNewParameter</span><span class="p">(</span><span class="n">dbCommand</span><span class="p">,</span> <span class="s">&quot;personID&quot;</span><span class="p">,</span> <span class="n">personID</span><span class="p">,</span>
      <span class="n">ParameterDirection</span><span class="p">.</span><span class="n">Input</span><span class="p">,</span> <span class="n">DbType</span><span class="p">.</span><span class="n">Int32</span><span class="p">));</span>

    <span class="n">dbCommand</span><span class="p">.</span><span class="n">Parameters</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">CreateNewParameter</span><span class="p">(</span><span class="n">dbCommand</span><span class="p">,</span> <span class="s">&quot;ReturnTime&quot;</span><span class="p">,</span> <span class="n">returnTime</span><span class="p">,</span>
      <span class="n">ParameterDirection</span><span class="p">.</span><span class="n">InputOutput</span><span class="p">,</span> <span class="n">DbType</span><span class="p">.</span><span class="n">DateTime</span><span class="p">));</span>

    <span class="n">dbCommand</span><span class="p">.</span><span class="n">Parameters</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">CreateNewParameter</span><span class="p">(</span><span class="n">dbCommand</span><span class="p">,</span> <span class="s">&quot;ReturnID&quot;</span><span class="p">,</span> <span class="n">returnID</span><span class="p">,</span>
      <span class="n">ParameterDirection</span><span class="p">.</span><span class="n">InputOutput</span><span class="p">,</span> <span class="n">DbType</span><span class="p">.</span><span class="n">Int32</span><span class="p">));</span>

    <span class="k">return</span> <span class="k">new</span> <span class="n">OrmLiteStoredProcedureWrapper</span>
    <span class="p">{</span>
        <span class="n">Statement</span> <span class="p">=</span> <span class="k">new</span> <span class="n">OrmLiteSPStatement</span><span class="p">(</span><span class="n">dbCommand</span><span class="p">),</span>
        <span class="n">DbCommand</span> <span class="p">=</span> <span class="n">dbCommand</span>
    <span class="p">};</span>
<span class="p">}</span>
</code></pre></div>
<p>In the end your stored procedure execution and retrieval of the output parameters can look like the following:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">db</span> <span class="p">=</span> <span class="n">_connectionFactory</span><span class="p">.</span><span class="n">OpenDbConnection</span><span class="p">())</span>
<span class="p">{</span>
    <span class="n">ReturnTime</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">;</span>
    <span class="kt">var</span> <span class="n">sp</span> <span class="p">=</span> <span class="n">db</span><span class="p">.</span><span class="n">dbo_USP_SavePerson</span><span class="p">(</span><span class="n">PersonID</span><span class="p">,</span> <span class="n">ReturnTime</span><span class="p">,</span> <span class="n">ReturnId</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">rowsAffected</span> <span class="p">=</span> <span class="n">sp</span><span class="p">.</span><span class="n">Statement</span><span class="p">.</span><span class="n">ExecuteNonQuery</span><span class="p">();</span>
    <span class="c1">// get output parameters</span>
    <span class="n">PersonID</span> <span class="p">=</span> <span class="n">ReturnId</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="n">ToInt32</span><span class="p">(</span><span class="n">sp</span><span class="p">.</span><span class="n">DbCommand</span><span class="p">.</span><span class="n">Parameters</span><span class="p">[</span><span class="s">&quot;ReturnID&quot;</span><span class="p">].</span><span class="n">Value</span><span class="p">);</span>
    <span class="n">ReturnTime</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="n">ToDateTime</span><span class="p">(</span><span class="n">sp</span><span class="p">.</span><span class="n">DbCommand</span><span class="p">.</span><span class="n">Parameters</span><span class="p">[</span><span class="s">&quot;ReturnTime&quot;</span><span class="p">].</span><span class="n">Value</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>Special thanks to <a href="https://github.com/gkathire">Guru Kathiresan</a> for creating the templates.</strong></p>

<p><em>At the end of the day the less code we manually write the better.</em></p>

</div>

<div class="tags">
Tags
 <div class='tag'>C#</div>  <div class='tag'>codegeneration</div>  <div class='tag'>OrmLite</div>  <div class='tag'>servicestack</div>  <div class='tag'>sql</div> 
</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
          <a href="//code/2014/06/28/alternate-way-to-build-your-own-football-db-sqlite-database/">
            Alternate way to build your own football.db sqlite database
            <small>28 Jun 2014</small>
          </a>
      </li>
    
      <li>
          <a href="//fun/2014/06/07/building-a-raspberry-pi-photo-frame/">
            Building a Raspberry Pi Photo Frame
            <small>07 Jun 2014</small>
          </a>
      </li>
    
      <li>
          <a href="//code/2014/06/06/resolving-angularjs-paths-in-asp-mvc-spa-iis/">
            Resolving AngularJS paths in a ASP.NET MVC SPA and IIS
            <small>06 Jun 2014</small>
          </a>
      </li>
    
  </ul>
</div>

      <div class="footer">
        <p>
          <a href="https://github.com/jokecamp/jokecamp.com">View Source on GitHub</a> |
          <a href="/atom.xml" title="Atom Feed">Atom</a> | <a href="/rss.xml" title="RSS Feed">RSS</a></p>
        <p>Contact me at <a href="mailto:joe.kampschmidt@gmail.com" alt="email me">joe.kampschmdit@gmail.com</p>
      </div>
    </div>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-101247-6', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>
